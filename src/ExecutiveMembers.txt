import React, { useEffect, useRef, useState } from "react";
import { motion } from "framer-motion";
import NavbarMenus from "/src/components/NavbarMenus";
import Footer from "/src/components/footer.jsx";

import avatar from "/src/assets/members/avatar.png";
import DrMohammadZashimUddin from "/src/assets/members/DrMohammadZashimUddin.jpeg";
import MohammadNurulIslam from "/src/assets/members/MohammadNurulIslam.jpeg";
import DrMohammedAlmajaddedeAlfasane from "/src/assets/members/DrMohammedAlmajaddedeAlfasane.jpeg";
import RashedKamalAnik from "/src/assets/members/RashedKamalAnik.jpeg";
import KhalidHossain from "/src/assets/members/KhalidHossain.jpeg";
import RafiulIslam from "/src/assets/members/RafiulIslam.jpg";
import MahfujHassan from "/src/assets/members/MahfujHassan.jpeg";
import AbulaisShomrat from "/src/assets/members/AbulaisShomrat.jpeg";
import OmarFaruqueMazumder from "/src/assets/members/OmarFaruqueMazumder.jpeg";

const orgHierarchy = [
  {
    level: "Board of Directors",
    members: [
      { designation: "Chairman", name: "Dr. Mohammad Zashim Uddin", photo: DrMohammadZashimUddin },
      { designation: "Vice President", name: "Mohammad Nurul Islam", photo: MohammadNurulIslam },
      { designation: "General Secretary", name: "Dr. Mohammed Almajaddede Alfasane", photo: DrMohammedAlmajaddedeAlfasane },
      { designation: "Treasurer", name: "Rashed Kamal Anik", photo: RashedKamalAnik },
      { designation: "Organizing Secretary", name: "Khalid Hossain", photo: KhalidHossain },
      { designation: "Executive Member 01", name: "Abulais Shomrat", photo:  AbulaisShomrat},
      { designation: "Executive Member 02", name: "Omar Faruque Mazumder", photo: OmarFaruqueMazumder },
    ],
  },
  {
    level: "CEO",
    members: [
      { designation: "Chief Executive Officer", name: "Dr. Mohammed Almajaddade Alfasane", photo: DrMohammedAlmajaddedeAlfasane },
    ],
  },
  {
    level: "Advisors",
    members: [
      { designation: "Advisor", name: "Dr. Akhtar Hossain Khan", photo: avatar },
      { designation: "Advisor", name: "Dr. Abdus Salam", photo: avatar },
      { designation: "Advisor", name: "Dr. Muhammad Ekramul Haque", photo: avatar },
      { designation: "Advisor", name: "Dr. ASM Mohiuddin", photo: avatar },
    ],
  },
  {
    level: "CEO Subordinates",
    members: [],
    subGroups: [
      {
        level: "Program Director",
        members: [
          { designation: "Program Director", name: "Rashed Kamal Anik", photo: RashedKamalAnik },
        ],
        sub: [
          { designation: "Head of Corporate Affairs", name: "Rafiul Islam", photo: RafiulIslam },
          { designation: "Head of IT", name: "Mahfuj Hassan", photo: MahfujHassan },
        ],
      },
      {
        level: "Research Director",
        members: [
          { designation: "Research Director", name: "Abulais Somrat", photo: avatar },
        ],
        sub: [
          { designation: "Research Section 01", name: "Zinia Naz Linde", photo: avatar },
          { designation: "Research Section 02", name: "Md Khalid Hossain", photo: avatar },
        ],
      },
      {
        level: "Admin (HR) & Finance",
        members: [
          { designation: "Admin (HR)", name: "Sheikh Rasheduzzaman", photo: avatar },
        ],
        sub: [
          { designation: "HR Member 01", name: "HR Member 01", photo: avatar },
          { designation: "HR Member 02", name: "HR Member 02", photo: avatar },
          { designation: "HR Member 03", name: "HR Member 03", photo: avatar },
        ],
      },
    ],
  },
];

const fadeIn = {
  hidden: { opacity: 0, y: 30 },
  visible: (i = 1) => ({
    opacity: 1,
    y: 0,
    transition: { duration: 0.6, delay: i * 0.08 },
  }),
};

export default function ExecutiveMembers() {
  const [showNav, setShowNav] = useState(false);
  const handleNav = () => setShowNav(!showNav);
  const containerRef = useRef(null);
  const cardRefs = useRef({});
  const [lines, setLines] = useState([]);

  const cardId = (gIdx) => `card-${gIdx}`;

  const buildConnectorPairs = () => {
    const pairs = [];
    for (let i = 0; i < orgHierarchy.length; i++) {
      const group = orgHierarchy[i];

      if (group.level === "Board of Directors") {
        const bodId = cardId(i);
        const ceoId = cardId(i + 1);
        const advisorsId = cardId(i + 2);
        pairs.push({ from: bodId, to: ceoId });
        pairs.push({ from: bodId, to: advisorsId });
        i += 2;
        continue;
      }

      if (group.level === "CEO Subordinates") {
        const ceoId = cardId(1);
        group.subGroups.forEach((sub, idx) => {
          const subId = cardId(i + idx);
          pairs.push({ from: ceoId, to: subId });
        });
        i += group.subGroups.length;
        continue;
      }

      if (i < orgHierarchy.length - 1) {
        pairs.push({ from: cardId(i), to: cardId(i + 1) });
      }
    }
    return pairs;
  };

  const computeLines = () => {
    const containerRect = containerRef.current?.getBoundingClientRect();
    if (!containerRect) return setLines([]);
    const pairs = buildConnectorPairs();
    const newLines = [];
    pairs.forEach(({ from, to }) => {
      const fromEl = cardRefs.current[from];
      const toEl = cardRefs.current[to];
      if (!fromEl || !toEl) return;

      const fRect = fromEl.getBoundingClientRect();
      const tRect = toEl.getBoundingClientRect();
      const x1 = fRect.left + fRect.width / 2 - containerRect.left;
      const y1 = fRect.top + fRect.height - containerRect.top;
      const x2 = tRect.left + tRect.width / 2 - containerRect.left;
      const y2 = tRect.top - containerRect.top;
      newLines.push({ x1, y1, x2, y2 });
    });
    setLines(newLines);
  };

  useEffect(() => {
    computeLines();
    const ro = new ResizeObserver(() => computeLines());
    if (containerRef.current) ro.observe(containerRef.current);
    window.addEventListener("resize", computeLines);
    window.addEventListener("scroll", computeLines, true);
    return () => {
      ro.disconnect();
      window.removeEventListener("resize", computeLines);
      window.removeEventListener("scroll", computeLines, true);
    };
  }, []);

  const setCardRef = (id) => (el) => {
    if (el) cardRefs.current[id] = el;
  };

  // Helper component for centered member layout
  const CenteredMembers = ({ members, className = "" }) => (
    <div className={`flex flex-wrap justify-center ${className}`}>
      {members.map((member, index) => (
        <div 
          key={index} 
          className="flex flex-col items-center group px-4 py-2"
          style={{ 
            flex: '0 0 auto',
            minWidth: '160px' // Ensures consistent spacing
          }}
        >
          <div className="w-36 h-36 rounded-full border-4 border-purple-400 overflow-hidden bg-white shadow-lg group-hover:border-purple-500 group-hover:shadow-xl transition-all duration-300">
            <img src={member.photo} alt={member.designation} className="w-full h-full object-cover" />
          </div>
          <h3 className="text-sm font-bold text-gray-800 mt-4 text-center">{member.designation}</h3>
          <p className="text-sm text-gray-600 text-center font-medium">{member.name}</p>
        </div>
      ))}
    </div>
  );

  const CenteredAdvisors = ({ members, className = "" }) => (
    <div className={`flex flex-wrap justify-center ${className}`}>
      {members.map((advisor, index) => (
        <div 
          key={index} 
          className="flex flex-col items-center group px-4 py-2"
          style={{ 
            flex: '0 0 auto',
            minWidth: '140px'
          }}
        >
          <div className="w-32 h-32 rounded-full border-4 border-emerald-300 overflow-hidden bg-white shadow-lg group-hover:border-emerald-400 group-hover:shadow-xl transition-all duration-300">
            <img src={advisor.photo} alt={advisor.designation} className="w-full h-full object-cover" />
          </div>
          <h4 className="text-sm font-semibold text-emerald-800 mt-3 text-center">{advisor.designation}</h4>
          <p className="text-xs text-gray-700 text-center font-medium">{advisor.name}</p>
        </div>
      ))}
    </div>
  );

  const CenteredSubMembers = ({ members, className = "" }) => (
    <div className={`flex flex-wrap justify-center ${className}`}>
      {members.map((member, index) => (
        <div 
          key={index} 
          className="flex flex-col items-center group px-3 py-2"
          style={{ 
            flex: '0 0 auto',
            minWidth: '130px'
          }}
        >
          <div className="w-28 h-28 rounded-full border-4 border-emerald-300 overflow-hidden bg-white shadow-lg group-hover:border-emerald-400 group-hover:shadow-xl transition-all duration-300">
            <img src={member.photo} alt={member.designation} className="w-full h-full object-cover" />
          </div>
          <h4 className="text-xs font-medium text-gray-700 mt-2 text-center">{member.designation}</h4>
          <p className="text-xs text-gray-600 text-center">{member.name}</p>
        </div>
      ))}
    </div>
  );

  return (
    <div className="relative min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 py-0 px-0">
      {/* Header Section */}
      <div className="w-full bg-gradient-to-r from-green-800 to-emerald-700 shadow-lg">
        <NavbarMenus showNav={showNav} handleNav={handleNav} />
        <div className="py-8">
          <h1 className="text-4xl font-bold text-center text-white mb-2">
            BSERI Member Panel
          </h1>
          <p className="text-lg text-center text-green-100">
            Our Distinguished Leadership Team
          </p>
        </div>
      </div>

      {/* Main Content */}
      <div className="py-12 px-4">
        <div ref={containerRef} className="relative max-w-7xl mx-auto">
          {/* SVG overlay for lines */}
          <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ overflow: "visible" }}>
            {lines.map((line, idx) => (
              <g key={idx}>
                <line 
                  x1={line.x1} 
                  y1={line.y1} 
                  x2={line.x2} 
                  y2={line.y2} 
                  stroke="#059669" 
                  strokeWidth={2} 
                  strokeDasharray="4,4"
                  strokeLinecap="round" 
                />
                <circle cx={line.x2} cy={line.y2} r={4} fill="#059669" />
              </g>
            ))}
          </svg>

          {/* Organized Members with Center Alignment */}
          <div className="flex flex-col items-center space-y-20">
            {orgHierarchy.map((group, gi) => {
              if (group.level === "CEO") {
                const ceoGroup = group;
                const advisorsGroup = orgHierarchy[gi + 1];
                return (
                  <div key="ceo-advisors" className="flex flex-col lg:flex-row justify-center w-full max-w-6xl gap-8 lg:gap-12">
                    {/* CEO Card */}
                    <motion.div
                      initial="hidden"
                      whileInView="visible"
                      viewport={{ once: true, margin: "-100px" }}
                      variants={fadeIn}
                      custom={gi}
                      ref={setCardRef(cardId(gi))}
                      className="bg-white/80 backdrop-blur-lg border border-emerald-200 rounded-2xl shadow-xl p-8 flex-1 flex flex-col items-center transform hover:scale-[1.02] transition-all duration-300"
                    >
                      <div className="bg-gradient-to-r from-amber-500 to-amber-600 text-white px-6 py-2 rounded-full mb-6 shadow-lg">
                        <h2 className="text-xl font-bold text-center uppercase">{ceoGroup.level}</h2>
                      </div>
                      <div className="w-full flex justify-center">
                        <div className="flex flex-wrap justify-center gap-8 max-w-2xl">
                          {ceoGroup.members.map((member, mi) => (
                            <div key={mi} className="flex flex-col items-center group px-4">
                              <div className="w-40 h-40 rounded-full border-4 border-amber-400 overflow-hidden bg-white shadow-lg group-hover:border-amber-500 group-hover:shadow-xl transition-all duration-300">
                                <img src={member.photo} alt={member.designation} className="w-full h-full object-cover" />
                              </div>
                              <h3 className="text-base font-bold text-gray-800 mt-4 text-center">{member.designation}</h3>
                              <p className="text-sm text-gray-600 text-center font-medium">{member.name}</p>
                            </div>
                          ))}
                        </div>
                      </div>
                    </motion.div>

                    {/* Advisors Card */}
                    <motion.div
                      key="advisors"
                      initial="hidden"
                      whileInView="visible"
                      viewport={{ once: true, margin: "-100px" }}
                      variants={fadeIn}
                      custom={gi + 1}
                      ref={setCardRef(cardId(gi + 1))}
                      className="bg-white/80 backdrop-blur-lg border border-emerald-200 rounded-2xl shadow-xl p-8 flex-1 flex flex-col items-center transform hover:scale-[1.02] transition-all duration-300"
                    >
                      <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-2 rounded-full mb-6 shadow-lg">
                        <h2 className="text-xl font-bold text-center uppercase">{advisorsGroup.level}</h2>
                      </div>
                      <div className="w-full">
                        <CenteredAdvisors members={advisorsGroup.members} />
                      </div>
                    </motion.div>
                  </div>
                );
              }

              if (group.level === "CEO Subordinates") {
                return (
                  <div key="ceo-sub" className="flex flex-col lg:flex-row justify-center items-stretch w-full max-w-7xl gap-6">
                    {group.subGroups.map((sub, si) => (
                      <motion.div
                        key={si}
                        initial="hidden"
                        whileInView="visible"
                        viewport={{ once: true, margin: "-100px" }}
                        variants={fadeIn}
                        custom={gi + si}
                        ref={setCardRef(cardId(gi + si))}
                        className="bg-white/80 backdrop-blur-lg border border-emerald-200 rounded-2xl shadow-xl p-6 flex-1 flex flex-col items-center transform hover:scale-[1.02] transition-all duration-300"
                      >
                        <div className="bg-gradient-to-r from-blue-500 to-cyan-600 text-white px-6 py-2 rounded-full mb-6 shadow-lg w-full max-w-xs">
                          <h2 className="text-lg font-bold text-center uppercase">{sub.level}</h2>
                        </div>
                        
                        {/* Main Members */}
                        <div className="w-full mb-6 flex justify-center">
                          <div className="flex flex-wrap justify-center gap-6">
                            {sub.members.map((member, mi) => (
                              <div key={mi} className="flex flex-col items-center group px-4">
                                <div className="w-36 h-36 rounded-full border-4 border-blue-400 overflow-hidden bg-white shadow-lg group-hover:border-blue-500 group-hover:shadow-xl transition-all duration-300">
                                  <img src={member.photo} alt={member.designation} className="w-full h-full object-cover" />
                                </div>
                                <h4 className="text-sm font-semibold text-gray-800 mt-3 text-center">{member.designation}</h4>
                                <p className="text-xs text-gray-600 text-center font-medium">{member.name}</p>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Subordinate Members */}
                        {sub.sub && (
                          <div className="w-full border-t border-gray-200 pt-6">
                            <h5 className="text-sm font-semibold text-gray-600 text-center mb-4 uppercase tracking-wide">Team Members</h5>
                            <div className="w-full flex justify-center">
                              <CenteredSubMembers members={sub.sub} />
                            </div>
                          </div>
                        )}
                      </motion.div>
                    ))}
                  </div>
                );
              }

              if (group.level === "Advisors") return null;

              // Default case for other groups (Board of Directors)
              return (
                <motion.div
                  key={gi}
                  initial="hidden"
                  whileInView="visible"
                  viewport={{ once: true, margin: "-100px" }}
                  variants={fadeIn}
                  custom={gi}
                  ref={setCardRef(cardId(gi))}
                  className="bg-white/80 backdrop-blur-lg border border-emerald-200 rounded-2xl shadow-xl p-8 w-full max-w-6xl flex flex-col items-center transform hover:scale-[1.02] transition-all duration-300"
                >
                  <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-8 py-3 rounded-full mb-8 shadow-lg">
                    <h2 className="text-2xl font-bold text-center uppercase">{group.level}</h2>
                  </div>
                  <div className="w-full">
                    <CenteredMembers members={group.members} />
                  </div>
                </motion.div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Footer */}
      <Footer />
    </div>
  );
}